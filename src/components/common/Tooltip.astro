---
import { cn } from "../../utils/cn";

interface Props {
  content: string; // O texto que será copiado
  label?: string; // O texto do tooltip (padrão: "Copiar")
  className?: string; // Classes para o container
  position?: "top" | "bottom"; // Posição do tooltip
}

const { 
  content, 
  label = "Clique para copiar", 
  className = "",
  position = "bottom"
} = Astro.props;

const tooltipClasses = cn(
  "absolute left-1/2 -translate-x-1/2 px-3 py-1.5",
  "bg-[#643390] text-white text-xs font-serif rounded-lg opacity-0 group-hover:opacity-100",
  "transition-all duration-300 pointer-events-none whitespace-nowrap z-50",
  "shadow-lg border border-white/10",
  position === "top" ? "-top-10" : "-bottom-10",
  // Adiciona uma setinha (opcional, mas fica legal)
  "after:content-[''] after:absolute after:left-1/2 after:-translate-x-1/2 after:border-4",
  position === "top" 
    ? "after:top-full after:border-t-[#643390] after:border-r-transparent after:border-b-transparent after:border-l-transparent" 
    : "after:bottom-full after:border-b-[#643390] after:border-r-transparent after:border-t-transparent after:border-l-transparent"
);
---

<button 
  class={cn("relative group cursor-pointer bg-transparent border-none p-0 flex items-center", className)}
  data-copy-content={content}
  aria-label={`Copiar ${content}`}
>
  <slot />
  
  <span class={tooltipClasses} data-tooltip-label>
    {label}
  </span>
</button>

<script>
  function initTooltips() {
    const buttons = document.querySelectorAll('button[data-copy-content]');
    
    buttons.forEach(btn => {
      // Evita adicionar múltiplos listeners se a função for chamada novamente
      if (btn.hasAttribute('data-initialized')) return;
      btn.setAttribute('data-initialized', 'true');

      btn.addEventListener('click', async () => {
        const content = btn.getAttribute('data-copy-content');
        const tooltip = btn.querySelector('[data-tooltip-label]');
        const originalLabel = tooltip?.textContent;
        
        if (!content) return;

        try {
          await navigator.clipboard.writeText(content);
          
          if (tooltip) {
            tooltip.textContent = "Copiado!";
            // Reset text after 2 seconds
            setTimeout(() => {
              tooltip.textContent = originalLabel || "Clique para copiar";
            }, 2000);
          }
        } catch (err) {
          console.error('Falha ao copiar:', err);
          if (tooltip) tooltip.textContent = "Erro ao copiar";
        }
      });
    });
  }

  // Inicializa quando o DOM estiver pronto
  document.addEventListener('DOMContentLoaded', initTooltips);
  // Re-inicializa em navegações do Astro (View Transitions se estiver sendo usado, ou simulação)
  document.addEventListener('astro:page-load', initTooltips);
  
  // Script inline para garantir execução imediata se necessário (fallback)
  initTooltips();
</script>
