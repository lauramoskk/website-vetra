---
import SectionLayout from "../../layouts/SectionLayout.astro";

import Title from "../Title.astro";
import Description from "../Description.astro";
import { cn } from "../../utils/cn";

// Navigation Items
const navItems = [
  { id: "overview", label: "1. Executive Overview" },
  { id: "how-it-works", label: "2. How It Works" },
  { id: "invariant", label: "3. 1:1 Invariant (the “safety brake”)" },
  {
    id: "backing",
    label: "4. Backing and Partnership with FT Asset Management KB",
  },
  { id: "controls", label: "5. Controls, Roles, and Governance" },
  { id: "security", label: "6. Security and Incident Response" },
  { id: "transparency", label: "7. Transparency and Reporting" },
  { id: "economics", label: "8. Economic Parameters (Tokenomics)" },
  { id: "roadmap", label: "9. Implementation Roadmap" },
  { id: "audit", label: "10. Audit and Verification" },
  { id: "use-cases", label: "11. Use Cases" },
  { id: "team", label: "12. Team, Contacts, and Verification" },
  { id: "legal", label: "13. Legal Notice" },
];

// Content Data (Currently only Overview is populated as per instructions)
const contentData = {
  overview: {
    title: "Executive Overview",
    text: "VETRA (VTR) is an institutional stablecoin backed 1:1 by U.S. dollars and deployed on the Polygon network. For each mint, the contract guarantees that total supply does not exceed the value of reserves. Reserves are updated via Chainlink Functions and recorded on-chain with an eight-decimal USD value, a timestamp, and a security identifier. The backing is provided by FT Asset Management KB, headquartered in Stockholm, with an initial commitment of USD 100,000,000.00 dedicated to the currency’s liquidity, credibility, and stability.",
  },
  "how-it-works": {
    title: "How It Works",
    text: "Content for How It Works coming soon...",
  },
  // Add other placeholders if needed, or handle dynamically
};

// Styles
const sectionOuterClasses = cn("flex items-start w-full relative");
const sectionInnerClasses = cn("w-full h-auto py-[88px] relative"); // Ensure relative for absolute positioning context if needed
const mainLayoutClasses = cn(
  "grid grid-cols-1 lg:grid-cols-12 gap-[72px] w-full relative z-10 items-start", // Items start for sticky
);

// Navigation Styles
const navColumnClasses = cn(
  "lg:col-span-4 flex flex-col gap-4 relative min-w-0", // Added min-w-0 to prevent grid blowout
  "lg:sticky lg:top-24", // Sticky positioning for desktop
);
const navItemClasses = (isActive: boolean) =>
  cn(
    "flex items-center justify-between p-4 rounded-[32px] cursor-pointer transition-all duration-300 text-sm font-medium",
    isActive
      ? "bg-[#1E0B2B] text-[#B073FF] border border-[#3D1D55]"
      : "bg-transparent text-gray-400 hover:text-white hover:bg-white/5",
  );

// Content Styles
const contentColumnClasses = cn(
  "lg:col-span-8 flex flex-col gap-2",
  "lg:sticky lg:top-24 self-start", // Content sticky with self-start for grid
);
---

<SectionLayout
  outerClassName={sectionOuterClasses}
  innerClassName={sectionInnerClasses}
  autoMargin={true}
>
  <div class={mainLayoutClasses}>
    {/* Navigation Column */}
    <div class={navColumnClasses}>
      {/* Mobile: Horizontal Scroll / Desktop: Vertical List */}
      <div
        class={cn(
          "flex lg:flex-col gap-4",
          "max-lg:overflow-x-auto max-lg:pb-4 max-lg:snap-x",
          "max-w-[280px] max-md:max-w-full w-full hide-scrollbar",
        )}
        id="whitepaper-nav"
      >
        {
          navItems.map((item, index) => (
            <button
              class={cn(
                "nav-item whitespace-nowrap lg:whitespace-normal text-left max-lg:snap-start shrink-0",
                "px-4 py-2 min-h-[52px] rounded-full cursor-pointer", // Pill on mobile, standard on desktop
                index === 0 // Default active
                  ? "bg-[#190C26] text-light-purple"
                  : "text-text-grey hover:text-white transition-colors",
              )}
              data-id={item.id}
            >
              <span class="flex items-center justify-between w-full gap-4 font-serif text-[14px] leading-[18px]">
                {item.label}
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class={cn("w-4 min-w-4 h-4 transition-transform")}
                >
                  <path d="M5 12h14" />
                  <path d="m12 5 7 7-7 7" />
                </svg>
              </span>
            </button>
          ))
        }
      </div>
    </div>

    {/* Content Column */}
    <div class={contentColumnClasses} id="whitepaper-content-area">
      <Title
        text={contentData.overview.title}
        className="text-left text-[24px] leading-[32px] max-md:text-[24px] max-md:leading-[32px]"
      />
      <Description
        text={contentData.overview.text}
        className="text-left text-text-grey"
      />
    </div>
  </div>
</SectionLayout>

<script>
  // Simple client-side logic for checking active state and updating content
  // Note: For a static site, we might want to render all content and hide/show,
  // or use a lightweight framework wrapper. Here we'll use vanilla JS for simplicity.

  const contentData = {
    overview: {
      title: "Executive Overview",
      text: `VETRA (VTR) is an institutional stablecoin backed 1:1 by U.S. dollars and
deployed on the Polygon network.
For each mint, the contract guarantees that total supply does not exceed the
value of reserves. Reserves are updated via Chainlink Functions and recorded
on-chain with an eight-decimal USD value, a timestamp, and a security
identifier.
The backing is provided by FT Asset Management KB, headquartered in
Stockholm, with an initial commitment of USD 100,000,000.00 dedicated to the
currency’s liquidity, credibility, and stability.`,
    },
    "how-it-works": {
      title: "How It Works",
      text: `VETRA integrates a reserves data source maintained by FT Asset Management
KB into the smart contract through Chainlink Functions.
At defined intervals, the function queries FT Asset Management KB’s API and
returns to the contract a snapshot containing the aggregate USD value, the exact
time of the reading, and a nonce that prevents unintended re-executions. The
use of a monotonic nonce guarantees chronological ordering of reserve updates
and prevents replay attacks.
Every new mint checks whether the snapshot is still within its validity window
(TTL) and whether the proposed issuance maintains the 1:1 relationship between
supply and reserves. To ensure Reserve Freshness, the TTL is 15 minutes. If
any criterion fails, the transaction is rejected.`,
    },
    invariant: {
      title: "1:1 Invariant (the “safety brake”)",
      text: `Reserves are recorded with eight decimals for USD, while the VTR token
operates with eighteen decimals.
To compare them correctly, the contract uses a fixed scaling factor to align
magnitudes before checking. This scaling factor is 1010 (1e10). The reserve
value in USD (8 decimals) is multiplied by 1010 (1e10) to align with the token’s
18-decimal precision before the comparison.
The safety rule is objective: the sum of current supply (totalSupply) and the
amount proposed to mint (amount) may not exceed the scaled reserve value
(scaled_reserves). In addition, the snapshot must be valid in time (within TTL).
In compact terms: totalSupply + amount ≤ scaled_reserves and snapshot within
TTL.`,
    },
    backing: {
      title: "Backing and Partnership with FT Asset Management KB",
      text: `The U.S. dollar backing is maintained by FT Asset Management KB, which
initially allocated USD 100 million to support VETRA’s liquidity, credibility,
and stability. This amount may grow as usage and project performance evolve.
On-chain, the contract publishes only what is necessary to validate minting:
• The aggregate reserve value, recorded with eight decimals;
• The time of measurement (timestamp);
• A security identifier (nonce).
The institutional layer is complemented by operational reports and
documentation, including the publication of the snapshot history and the
management of KYC/AML processes.`,
    },
    controls: {
      title: "Controls, Roles, and Governance",
      text: `The VETRA contract follows the ERC-20 standard and uses a UUPS
(upgradeable) architecture. This security pattern enables technological
evolution, implementing future improvements, while preserving state and all
token balances. Authorization for any upgrade is restricted and controlled by
governance.
Operational security is ensured through Role-Based Access Control (RBAC)
that separates responsibilities:
• DEFAULT_ADMIN_ROLE (Administration): Governance of the
contract. This role can configure parameters, manage upgrades via
UUPS, and activate the Emergency Pause mechanism for critical
situations.
• MINTER_ROLE (Minting): Authorized to mint new VTR tokens.
Minting is strictly conditioned on on-chain checks, ensuring the Supply
Invariant and TTL are respected.
• BURNER_ROLE (Burning): Authorized to burn VTR tokens, including
Operator Burn for any account in line with operational policy.
Additional security resources include the Pausable mechanism to halt critical
functions, an Optional Allowlist to restrict minting to pre-approved addresses, 
and an Optional Per-Transaction Mint Limit to set a maximum per-transaction
mint amount.`,
    },
    security: {
      title: "Security and Incident Response",
      text: `VETRA’s security is engineered in multiple layers. Beyond the 1:1 economic
brake that enforces the Supply Invariant for all mints, the contract can be paused
(Pausable) to respond quickly to unexpected events or malicious activity.
UUPS and RBAC support structural security.
The integrity of reserve updates is protected by a 15-minute TTL (preventing
stale data) and a monotonic nonce (preventing response replay and enforcing
chronological order). To mitigate exposure, Chainlink Functions integration
secrets are managed off-chain.
If reserves become stale, the contract will reject transactions until a fresh update
is performed. In case of malicious activity, the pause mechanism may be
triggered according to incident-response policies, operated under security
controls (e.g., multisig), and with an on-chain audit trail.`,
    },
    transparency: {
      title: "Transparency and Reporting",
      text: `VETRA’s transparency is implemented in two layers: on-chain (immediate
auditability) and off-chain (institutional reporting and compliance).
The contract emits comprehensive events for all critical protocol operations.
This includes real-time event monitoring of reserve updates and all mint/burn
operations (e.g., TokensMinted / TokensBurned). These events guarantee a
complete and public audit trail of state changes.
The team commits to maintaining periodic reports on performance and project
evolution. To facilitate public auditability, a historical record of reserve
snapshots will be published. Each entry will include the measurement time in
UTC, the eight-decimal balance (the native USD-reserve format), and on-chain
transaction references, while preserving sensitive data off-chain.
The Implementation Roadmap includes developing and publishing a public
reserves dashboard with snapshot history in a future phase.
KYC/AML and compliance obligations are conducted in an institutional offchain environment by the issuer and the custodian, in accordance with the
applicable framework in each jurisdiction. This separation keeps the contract
focused on on-chain economic security and public auditability, without
prejudice to regulatory responsibilities carried out by qualified entities.`,
    },
    economics: {
      title: "Economic Parameters (Tokenomics)",
      text: `VTR is a fully compliant ERC-20 token operating with the standard precision of
18 decimals. This precision differs from the eight-decimal precision used for
storing the USD reserve value.
Supply is dynamic: it grows when minting is backed by valid reserves and
decreases with burns. Supply is strictly controlled by the Supply Invariant,
which enforces that the sum of current supply and the amount proposed to mint
cannot exceed the scaled reserve value.
The VETRA contract does not embed transfer fees, preserving neutrality as a
means of payment and unit of account. There are no algorithmic “price control”
mechanisms; token stability and discipline derive purely from the ChainlinkFunctions-based Proof-of-Reserves and the strict enforcement of the mint
invariant.`,
    },
    roadmap: {
      title: "Implementation Roadmap",
      text: `The current phase focuses on the protocol’s basic and operational
implementation. This covers Polygon deployment, establishing the Proof-ofReserves cycle via Chainlink Functions, and configuring role-based governance
(RBAC), including the ability to pause the contract in emergencies.
The next immediate steps target transparency and resilience: a public reserves
dashboard with snapshot history, integration of redundant data sources, and
automation of update routines.
In a subsequent phase, focus will shift to institutional expansion—allowing
VETRA to aggregate multiple sources of backing, broaden integrations with
payment and compliance systems, and enhance the institutional mint/redeem
experience.
Roadmap initiatives are subject to technical validations, independent audits, and
regulatory requirements, and may be adjusted in scope and priority.`,
    },
    audit: {
      title: "Audit and Verification",
      text: `VETRA will undergo an independent security audit prior to public launch. The
report will be made available through official channels once completed.
The comprehensive audit scope will cover the protocol’s central elements:
• UUPS upgradeability and initialization;
• Role-Based Access Control (RBAC) governance;
• Mint and burn invariants;
• Chainlink Functions flow and reserve-data controls;
• Operational security parameters (TTL, per-transaction mint limit,
allowlist);
• Event trail.
At the end of the process, the public report will be published with official
identification and link. In parallel, the project will maintain continuous
monitoring, operational alerts, and a responsible disclosure process for any
vulnerabilities`,
    },
    "use-cases": {
      title: "Use Cases",
      text: `VETRA is designed to offer stability and efficiency, meeting diverse needs in
corporate and decentralized contexts that require financial predictability.
The VTR token is optimized for institutional adoption, serving needs such as
low-cost, predictable corporate settlements; acting as digital treasury with a
stable unit of account; and facilitating cross-border payments.
Web3 projects that depend on reliable collateral benefit from VETRA’s
embedded technical guarantees. The protocol design delivers stable and easily
auditable behavior through the 1:1 invariant, reserve-freshness control, and
role-based governance.`,
    },
    team: {
      title: "Team, Contacts, and Verification",
      text: `VETRA’s leadership is exercised by Pedro Fares Ramos (Founder, Chairman &
CEO) and Rosemberg Alves Nascimento (Co-Founder & Head of Global
Partnerships), and includes Christine Schöberlein (European Reserve
Custodian), responsible for managing VETRA’s institutional custody
relationship with FT Asset Management KB in Sweden, ensuring compliance
with European regulatory standards and transparent reserve management.
Critical addresses for contract operation and verification, such as proxy and
implementation, the Chainlink Functions subscriptionId, and the wallets
responsible for administration, minting, and burning, will be disclosed through
official channels after a stable mainnet deploy.`,
    },
    legal: {
      title: "Legal Notice",
      text: `This document is strictly informational. Its content is subject to updates, at any
time and without prior notice, to reflect contractual, operational, technological,
or regulatory changes. In the event of any discrepancy, the official information
published through VETRA’s institutional channels prevails, including our X.`,
    },
  };

  function initWhitepaperTabs() {
    const navItems = document.querySelectorAll(".nav-item");
    const contentArea = document.getElementById("whitepaper-content-area");

    if (!navItems.length || !contentArea) return;

    navItems.forEach((item) => {
      item.addEventListener("click", () => {
        // Remove active class from all
        navItems.forEach((nav) => {
          nav.classList.remove("bg-[#190C26]", "text-light-purple");
          nav.classList.add(
            "text-text-grey",
            "hover:text-white",
            "transition-colors",
          );
        });

        // Add active class to clicked
        item.classList.remove(
          "text-text-grey",
          "hover:text-white",
          "transition-colors",
        );
        item.classList.add("bg-[#190C26]", "text-light-purple");

        // Update Content
        const id = item.getAttribute("data-id");
        if (!id) return; // Guard clause

        // Type safe access for vanilla JS in Astro
        // @ts-ignore
        const data = contentData[id] || {
          title: item.textContent.trim().replace(/^\d+\.\s*/, ""),
          text: "Content coming soon...",
        };

        // We need to query selector specifically inside the content area to update safely
        // But since we used components, we might need to swap innerHTML or similar.
        // A cleaner way for Astro components is often having them all rendered and toggling hidden.
        // But for this quantity of text, replacing innerHTML is fine for a simple task.

        // Re-construct the HTML structure to match Title/Description components
        // Title: h2 with classes
        // Description: p with classes

        // Use a fade effect
        contentArea.style.opacity = "0";
        setTimeout(() => {
          contentArea.innerHTML = `
                <div class="flex flex-col gap-2 text-left">
                    <h2 class="font-sans text-[24px] md:text-[24px] leading-[32px] font-medium text-text-secondary">
                        ${data.title}
                    </h2>
                    <p class="font-serif text-[16px] md:text-[16px] leading-[20px] text-text-grey">
                        ${data.text}
                    </p>
                </div>
            `;
          contentArea.style.opacity = "1";
        }, 200);
      });
    });
  }

  document.addEventListener("astro:page-load", initWhitepaperTabs);
  // Also run initially in case view transitions aren't used or fallback
  if (document.readyState === "complete") {
    initWhitepaperTabs();
  } else {
    document.addEventListener("DOMContentLoaded", initWhitepaperTabs);
  }
</script>

<style>
  /* Custom scrollbar hiding */
  .hide-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .hide-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>
