---
import SectionLayout from "../../layouts/SectionLayout.astro";
import AlignmentLayout from "../../layouts/AlignmentLayout.astro";
import Title from "../Title.astro";
import Description from "../Description.astro";
import Badge from "../Badge.astro";
import { cn } from "../../utils/cn";
import { Image } from "astro:assets";
import StarsIcon from "../../assets/icons/stars-light-sparkle.svg";
import SecurityIcon from "../../assets/icons/shield-check.svg";
import EcosystemIcon from "../../assets/icons/globe.svg";
import TransparencyIcon from "../../assets/icons/eye.svg";
import ScalabilityIcon from "../../assets/icons/zap.svg";

// Styles
const sectionOuterClasses = cn(
  "flex items-center w-full relative",
  "why-choose-vetra-section",
);

const sectionInnerClasses = cn(
  "w-full lg:h-[840px] h-auto max-sm:py-[88px]", // Removed overflow-hidden to allow mask to work correctly
);

const mainLayoutClasses = cn(
  "gap-16 relative z-10 lg:h-full h-auto", // Spacing between header and cards
  "max-sm:flex-col",
);

const headerClasses = cn("gap-4", "max-w-[788px] text-center mx-auto");

const gridClasses = cn(
  "grid grid-cols-1 gap-6 w-full py-[88px]",
  "lg:flex lg:flex-col lg:gap-8 lg:w-full", // Desktop: Vertical layout
  "max-sm:grid-cols-1", // Mobile adapt
);

const cardClasses = cn(
  "bg-white/10 backdrop-blur-[80px] rounded-[8px]", // Matching MostTrusted style
  "flex flex-col",
  "hover:bg-white/20 transition-colors duration-300",
  "lg:w-full lg:shrink-0 lg:h-auto", // Full width on desktop
);
---

<SectionLayout
  outerClassName={sectionOuterClasses}
  innerClassName={sectionInnerClasses}
  autoMargin={true}
>
  <AlignmentLayout
    direction="horizontal"
    justify="center"
    align="center"
    className={mainLayoutClasses}
  >
    <!-- Header Section -->
    <AlignmentLayout
      direction="vertical"
      justify="center"
      align="start"
      className={headerClasses}
    >
      <Badge text="The most trusted stablecoin">
        <Image
          src={StarsIcon}
          alt="Arrow"
          class="w-full h-full object-contain"
          width={12}
          height={12}
        />
      </Badge>
      <Title text="Why choose VETRA?" className="text-start" />
      <Description
        text="A stablecoin backed by real assets, powered by secure technology, and built on Polygon for scalability and trust."
        className="max-w-[588px] text-start"
      />
    </AlignmentLayout>

    <!-- Cards Grid -->
    <!-- Cards Grid Wrapper (Mask) -->
    <div
      class="w-full lg:flex-1 lg:overflow-hidden relative custom-scrollbar-hide cards-mask-effect"
      id="vetra-cards-mask"
      style="height: 100%;"
    >
      <div class={gridClasses} id="vetra-cards-container">
        <!-- Card 1: Security -->
        <div class={cardClasses}>
          <div class="w-full h-[184px]"></div>

          <AlignmentLayout
            direction="vertical"
            justify="center"
            align="center"
            className="flex-1 p-4 gap-2"
          >
            <Title
              text="Security"
              variant="secondary"
              className="text-center"
            />
            <Description
              text="Built with OpenZeppelin standards ERC-20 upgradeable (UUPS) and role-based controls that restrict mint and burn to 1â€“2 designated operators. An independent third-party security audit is planned to validate the implementation."
              className="text-center"
              variant="secondary"
            />
          </AlignmentLayout>
        </div>

        <!-- Card 2: Ecosystem -->
        <div class={cardClasses}>
          <div class="w-full h-[184px]"></div>

          <AlignmentLayout
            direction="vertical"
            justify="center"
            align="center"
            className="flex-1 p-4 gap-2"
          >
            <Title
              text="Ecosystem & Adoption"
              variant="secondary"
              className="text-center"
            />
            <Description
              text="Deliverables for real use: an upgradeable contract with AccessControl, Hardhat deploy scripts, comprehensive tests, detailed technical documentation, and support for Polygonscan verification."
              className="text-center"
              variant="secondary"
            />
          </AlignmentLayout>
        </div>

        <!-- Card 3: Transparency -->
        <div class={cardClasses}>
          <div class="w-full h-[184px]"></div>

          <AlignmentLayout
            direction="vertical"
            justify="center"
            align="center"
            className="flex-1 p-4 gap-2"
          >
            <Title
              text="Transparency"
              variant="secondary"
              className="text-center"
            />
            <Description
              text="Chainlink Functions audit the 1:1 backing, and every supply change is emitted as TokensMinted/TokensBurned events. Reserve updates are trackable on-chain, making circulation and backing straightforward to verify."
              className="text-center"
              variant="secondary"
            />
          </AlignmentLayout>
        </div>

        <!-- Card 4: Scalability -->
        <div class={cardClasses}>
          <div class="w-full h-[184px]"></div>

          <AlignmentLayout
            direction="vertical"
            justify="center"
            align="center"
            className="flex-1 p-4 gap-2"
          >
            <Title
              text="Scalability"
              variant="secondary"
              className="text-center"
            />
            <Description
              text="Deployed on Polygon PoS for fast confirmations and low fees, while maintaining full EVM compatibility with wallets, bridges, and dApps."
              className="text-center"
              variant="secondary"
            />
          </AlignmentLayout>
        </div>
      </div>
    </div>
  </AlignmentLayout>
</SectionLayout>

<style>
  @media (min-width: 1024px) {
    .cards-mask-effect {
      mask-image: linear-gradient(
        to bottom,
        transparent,
        black 15%,
        black 85%,
        transparent
      );
      -webkit-mask-image: linear-gradient(
        to bottom,
        transparent,
        black 15%,
        black 85%,
        transparent
      );
    }
  }
</style>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  const initScroll = () => {
    const mm = gsap.matchMedia();

    mm.add("(min-width: 1024px)", () => {
      const section = document.querySelector(".why-choose-vetra-section");
      const mask = document.querySelector("#vetra-cards-mask");
      const container = document.querySelector("#vetra-cards-container");

      if (!section || !mask || !container) return;

      // Calculate translation distance
      const getScrollAmount = () => {
        return -(container.scrollHeight - mask.clientHeight);
      };

      const tween = gsap.to(container, {
        y: getScrollAmount,
        ease: "none",
        scrollTrigger: {
          trigger: section,
          pin: true,
          start: "top top",
          end: () => `+=${container.scrollHeight - mask.clientHeight + 300}`, // Increased scroll duration for smoother feel
          scrub: 1,
          invalidateOnRefresh: true,
          anticipatePin: 1,
        },
      });
    });
  };

  // Run on load
  initScroll();

  // No changes needed for bg yet, icon download is priority.
  document.addEventListener("astro:page-load", initScroll);
</script>
